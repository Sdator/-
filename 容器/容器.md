# 容器记录

- 环境
  - W10 平台

## WSL2 玩容器

- 有两种安装方式
  - linux 原生安装，使用官方提供的脚本安装
  - 搭配 docker for window 安装

### 解决运行问题

#### systemdctl 服务启动起来

```bash
# 安装daemonize
sudo apt-get install daemonize
# 执行以下命令开启
sudo daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit=basic.target
exec sudo nsenter -t $(pidof systemd) -a su - $LOGNAME
```

备用方法未测试

```bash
mv /usr/bin/systemctl /usr/bin/systemctl.old
curl https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py > /usr/bin/systemctl
chmod +x /usr/bin/systemctl
————————————————
版权声明：本文为CSDN博主「猪场少年」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/weixin_42195311/article/details/108467171
```

#### 服务启动报错 iptables 问题 👍

```bash
# 因为容器在启动中使用了 iptables 进行 nat 转发,由于debian 默认使用 nftables，你可以把转发条目转换为 nftables ,或者使用旧版 iptables
sudo update-alternatives --set iptables /usr/sbin/iptables-legacy
sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy

# 在没有 iptables 规则的情况下运行 dockerd 服务
dockerd --iptables=false
```

报错信息

> failed to start daemon: Error initializing network controller: error obtaining controller instance: failed to create NAT chain DOCKER: iptables failed: iptables --wait -t nat -N DOCKER: iptables v1.8.2 (nf_tables): CHAIN_ADD failed (No such file or directory): chain PREROUTING

参考

- https://forums.docker.com/t/failing-to-start-dockerd-failed-to-create-nat-chain-docker/78269
- https://blog.csdn.net/w851685279/article/details/108825893
- https://blog.csdn.net/weixin_42195311/article/details/108467171?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control

## 开启 tcp 远程连接

```bash
cat > /etc/docker/daemon.json <<EOF
{
"hosts": ["tcp://0.0.0.0:2376","unix:///var/run/docker.sock"]
}
EOF

cat > /etc/docker/daemon.json <<EOF
{
  "hosts": ["unix:///var/run/docker.sock", "tcp://127.0.0.1:2375"],
  "registry-mirrors": ["https://registry.docker-cn.com"]
}
EOF

# 设置远程服务主机地址
$Env:DOCKER_HOST = "tcp://x.x.x.x:2376"

```

## 踩坑

- 环境
  - W10 平台
  - git-bash
- 关键命令
  - $(cmd //c echo %CD%)
- 问题
  - 在 Window 下使用 git-bash 执行容器如何通过命令代入正确的路径？
- 解决方案
  - 在 WSL2 中执行容器相关指令即可解决 Window 平台的各种问题

### Windows 平台下正确读取路径的方法

```bash
docker run --rm -v $(cmd //c echo %CD%):/tmp -it sdator/tools ls -al
```

### 错误例子

```bash
# 但适合 linux 平台
docker run --rm -v `pwd`:/tmp -it sdator/tools ls -al
docker run --rm -v $(pwd):/tmp -it sdator/tools ls -al
docker run --rm -v "${pwd}":/tmp -it sdator/tools ls -al
```
